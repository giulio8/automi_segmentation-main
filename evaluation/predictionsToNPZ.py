'''
This script transforms the .png masks generated by the model into a 3D array and saves them as .npz files.
'''

import os
import sys

import numpy as np
import datapaths
import utils_data

def main(modelFolder, folds):
    for fold in folds:
        print(f'Fold: {fold}')
        evaluationSet = 'AUTOMI_test'
        foldName = f'fold{fold}predictions'
        newFoldName = f'fold{fold}predictionsNPZ'
        predictionsFolder = os.path.join(modelFolder, evaluationSet)
        foldFolder = os.path.join(predictionsFolder, foldName)
        newFoldFolder = os.path.join(predictionsFolder, newFoldName)

        # Gets unique patient names from the prediction folder
        patientNames = utils_data.getPatientNames(foldFolder)
        print('Patient names: {}'.format(patientNames))

        # Creates a new folder for the npz files
        if not os.path.isdir(newFoldFolder):
            os.mkdir(newFoldFolder)

        # For each patient, creates a npz file with the predictions
        for i, patientName in enumerate(patientNames):
            utils_data.convert_png_to_npz(patientName, foldFolder, newFoldFolder)


if __name__ == '__main__':
    if len(sys.argv) > 1:
        modelFolder = sys.argv[1]
    else:
        modelFolder = os.path.join(datapaths.resultspath, 'AUTOMI_PTV_tot_BCE_Loss_May_2023')

    folds = [1, 2, 3, 4, 5]
    main(modelFolder, folds)




